---
title: "Modelling the annual sentenced prisoner population"
subtitle: "`r format(Sys.time(), '%d %B, %Y')`"
author: "Caleb Moses"
documentclass: scrartcl
# bibliography: ../deepspeech.bib
# selfcitation: ../deepspeech-self.bib
clean: false
output:
  bookdown::pdf_document2:
    toc: true
    latex_engine: pdflatex
    fig_width: 5
    fig_height: 3
    fig_caption: true
    template: arsclassica.tex
    keep_tex: true
---

```{r setup-knitr, include=FALSE}
knitr::opts_chunk$set(
  echo = FALSE,
  message = FALSE,
  warning = FALSE,
  fig.align = 'center',
  fig.width = 5
  )
```

```{r setup}
library(tidyverse)
library(tidybayes)
library(rethinking)
library(kableExtra)
library(knitr)
library(furrr)
library(rstan)
library(brms)
library(here)
library(gt)

# Set multicore
options(mc.cores = min(parallel::detectCores() - 1, 10))

plan(multiprocess)

# Set default ggplot theme
theme_set(theme_minimal())

# Avoid recompilation of unchanged models
rstan_options(auto_write = TRUE)

source(here('scripts/zero_inflated_poisson_rr3.R'), local = TRUE)

```

```{r load-data}

fix_factor_levels <- function(x) {
    levels <- levels(x)
    res = unique(as.character(levels))
    end = c()
    if ("Other" %in% levels) {
        res <- res[res != "Other"]
        end <- c("Other")
    }
    if ("Unknown" %in% levels) {
        res <- res[res != "Unknown"]
        end <- c(end, "Unknown")
    }
    c(res, end)
}

duration_levels <- c(
    "Preventive detention",
    "6 months or less",
    "Over 6 months and up to 1 year",
    "Over 1 year and up to 2 years",
    "Over 2 years and up to 3 years",
    "Over 3 years and up to 5 years",
    "5 years or more",
    "Life imprisonment",
    "Unknown")

prison_pop <- read_csv(here('data/prison_pop_tidy.csv')) %>%
    mutate_if(is.character, factor) %>%
    mutate_if(is.numeric, as.integer) %>%
    mutate_if(is.factor, function(x) factor(x, levels = fix_factor_levels(x))) %>%
    mutate(Age = as.ordered(Age),
           Duration = ordered(Duration, levels = duration_levels))

```

# Introduction

I have collected the Annual Sentenced Prisoner Population for the latest Fiscal Years statistics, released annually by Stats NZ via the NZ.Stat website (http://nzdotstat.stats.govt.nz/).

The data is provided as randomly rounded counts^["Privacy, security, and confidentiality of information supplied to Statistics NZ" available here: https://bit.ly/2A9O22r], and contains the following variables.

- Year
- Sex
- Age
- Ethnicity
- Offence
- Duration
- Count

A list of the possible values for each variable is provided in table \@ref(tab:varsummary).

```{r varsummary}

prison_vars <- c("Year", "Sex", "Age", "Ethnicity", "Offence", "Duration", "Count")

prison_pop %>%
    select(-ends_with("Total")) %>%
    summarise_all(function(x) list(levels(x))) %>%
    t() %>%
    as_tibble() %>%
    rename(Values = V1) %>%
    mutate(Variable = prison_vars) %>%
    unnest(cols = Values, keep_empty = TRUE) %>%
    mutate(Variable = factor(Variable, levels = unique(Variable))) %>%
    mutate(Values = str_wrap(Values, width = 60)) %>%
    group_by(Variable) %>%
    summarise(Values = paste0(Values, collapse = "\n")) %>%
    mutate(Values = case_when(
               Variable == "Year" ~ sprintf("%d-%d", min(prison_pop$Year), max(prison_pop$Year)),
               Variable == "Count" ~ "Population counts, randomly rounded to base 3",
               TRUE ~ Values)) %>%
    mutate(Values = linebreak(Values)) %>%
    rename(`Variable name` = Variable, `List of values` = Values) %>%
    kable(escape = FALSE, booktabs = TRUE, linesep = "\\midrule", caption="An exhaustive list of values in the Annual Sentenced Prisoner Population dataset") %>%
    kable_styling(font_size = 10)

```

# See the data

```{r}

prison_pop %>%
    group_by(Ethnicity, Duration) %>%
    summarise(Count = sum(Count)) %>%
    filter(Ethnicity != "Unknown", Duration != "Unknown") %>%
    ggplot(aes(x = Duration, y = Count, fill = Duration)) +
    geom_bar(stat = 'identity') +
    facet_wrap(~Ethnicity) +
    theme(axis.text.x=element_blank(),
          axis.ticks.x=element_blank())

```

# Model the data

```{r zipois-model}

bform <- bf(Count ~ Sex + Age + Ethnicity + Offence + Duration, decomp = 'QR')

zipois_fit <- brm(
    bform, data = prison_pop,
    cores = 4,
    family = zero_inflated_poisson,
    save_model = here('models/zipois_fit.stan'),
    file = here('models/zipois_fit.rds')
    )

```
